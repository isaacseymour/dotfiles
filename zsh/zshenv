# Get Homebrew stuff on the path
export PATH="/usr/local/bin:/usr/local/sbin:$PATH"

# Rbenv
if which rbenv > /dev/null; then eval "$(rbenv init - zsh)"; fi

[[ -s $HOME/.tmuxinator/scripts/tmuxinator ]] && source $HOME/.tmuxinator/scripts/tmuxinator

if command -v gpg-agent; then
  if [ -f "${HOME}/.gpg-agent-info" ]; then
    . "${HOME}/.gpg-agent-info" &> /dev/null
  fi

  FOUND_GPG_PIDS=`ps aux | awk '{ print $2,$11 }' | grep gpg-agent | awk '{ print $1 }'`
  USED_GPG_PID=`echo $GPG_AGENT_INFO | cut -d':' -f2`

  kill_zshenv_shared() {
    echo "Detected outdated agent(s):"
    echo "GPG: file says $USED_GPG_PID, but $FOUND_GPG_PIDS is running."
    killall gpg-agent
    rm "${HOME}/.gpg-agent-info" &> /dev/null
  }

  if [ $FOUND_GPG_PIDS -a $USED_GPG_PID ]; then
    # If these exist but don't match, the running agents and file are out of sync.
    if [ $FOUND_GPG_PIDS != $USED_GPG_PID ]; then
      kill_zshenv_shared
    fi
  else
    # If some of these don't exist, either an agent isn't running, or nothing is in the file.
    kill_zshenv_shared
  fi

  if ! [ -f "${HOME}/.gpg-agent-info" ]; then
    touch "${HOME}/.gpg-agent-info"
    gpg-agent --daemon >> "${HOME}/.gpg-agent-info"

    . "${HOME}/.gpg-agent-info" &> /dev/null
  fi
fi
